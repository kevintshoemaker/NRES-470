---
title: "Matrix population models"
author: "NRES 470/670"
date: "Spring 2024"
output: 
  html_document: 
    theme: spacelab
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
```


```{r echo=FALSE}

#  NRES 470, Lecture 7  --------------------          
#   Kevin Shoemaker                                   
#   University of Nevada, Reno                        
#   Matrix population models                   

```


# Matrix population models

First of all, this lecture is full of R code (R makes it easy to run matrix population models!). If you want to follow along in R, you can find the R script [here](LECTURE7.R). I recommend right-clicking on the link, saving the script to a designated folder, and loading up the script in RStudio.     

## Why matrices? 

### Reason 1: simplify!

![](IM7.jpg)

You might recognize this InsightMaker model from Lab 3. This represents an age-structured population with only three age classes. Imagine if there were five age classes, or 10? What if you could jump from (e.g.) stage 3 to stage 5? Or from stage 5 back to stage 3? How many lines would you have to draw, how many equations would you have to put in all the different flows? It would be tedious, and you could easily run into errors that would be hard to uncover! 

![](teasel1.jpg){width=30%}

Consider the teasel example from our textbook. It's possible to implement this model in InsightMaker, but it would be tedious and prone to error. And this is far from the most complicated populations out there (although notice that plants can do some things that vertebrate animals can't do- for instance go backwards in developmental stage. With matrix models, there is an easier way!

![](gotelli3_6.jpg){width=50%}

The population vital rates for pretty much any age-structured or stage-structured population can be represented as a **transition matrix** (or, projection matrix), which summarizes all the information about survival, birth rates, and transitions between stages! (and the fact that a life history like teasel can be represented by a transition matrix illustrates the generality of this concept!)

For example, the teasel vital rates can be summarized in [this matrix](teaselmatrix1.csv):

```{r}

# Teasel example -------------------------------
# Teasel example from Gotelli: summarizing a complex life history!

teasel <- read.csv("teaselmatrix1.csv", header=T)      # read in the teasel transition matrix from Gotelli
teasel <- teasel[,-1]                                  # remove the row names
teasel_matrix <- as.matrix(teasel)                     # convert to a matrix (from a data frame)
colnames(teasel_matrix) <- names(teasel)               # assign row and column names
rownames(teasel_matrix) <- names(teasel)
teasel_matrix                                          # print the matrix

```

#### Stage-structure vs age-structure

In the previous module, we talked about 'age-structured populations'. What we meant by that is that the population vital rates (e.g., $b$ and $d$) varied by age. 

Sometimes, it's convenient to classify individuals within a certain age range as belonging to a particular life-history stage. For example, we might classify the life history of a grizzly bear like this:

Age 0-1: newborn     
Age 1-2: yearling     
Age 2-5: subadult     
Age 6+: adult     

This can simplify our models considerably. For example, consider a species like a sea turtle, with up to 75 or 100 years of life. You could build a model in which you have 100 [Stocks], one for each year of life. 

--OR--

You could have 5 [Stocks] representing age ranges over which sea turtles tend to have similar vital rates. For example, we might divide the sea turtle life history into the following stages:

Age 0-1: hatchling      
Age 1-5: young juvenile     
Age 5-10: older juvenile      
Age 10-17: subadult      
Age 18+: adult      

By using stages, we have simplified our model from having 100 stocks (with even more associated flows/transitions) to a model with only 5 stocks- and we are still accurately representing how vital rates change with age (i.e., the model is still *biologically realistic*). 

Matrix population models can represent age-structured and stage-structured models with equal simplicity and elegance. 

The term 'Leslie Matrix' refers to an age-structured matrix population model. 

When a matrix is used to represent a stage-structured population, it is often called a "Lefkovitch" (or stage-based) Matrix. 

### Reason 2: modeling age-structured population dynamics!

In one of the questions in Lab 3, you were asked to use a life table to predict the number of births in a population one time step into the future. As you probably realized, this is not as straightforward as it sounds!

Life tables are great for summarizing survivorship schedules and other aspects of age-structured populations. But life tables are not designed to model the abundance dynamics of age- or stage- structured populations! 

You know what *is* great for projecting age-structured abundance into the future? 

MATRICES of course!  

For example, let's project a teasel population 1 year into the future:

First of all, we need to begin with a teasel population **vector**...

```{r}

# Summarize initial age-structured abundance as a matrix with one column

Initial_teasel <- matrix(c(1000,1500,200,300,600,25),ncol=1)         # initial population size (population vector; matrix with 1 column!)
rownames(Initial_teasel) <- rownames(teasel_matrix)                  # add row and column names
colnames(Initial_teasel) <- "Abundance"
Initial_teasel

```

Then all we need to do is 'matrix-multiply' this **vector** of abundances by the **transition matrix** from above! Each time we do this multiplication step, we advance one year! It's that easy!

NOTE: matrix multiplication (percent-asterisk-percent in R) is not the same as standard multiplication (asterisk in R).

Here's how we can do this in R!

```{r}

# Project the population at time 1

Year1 <- teasel_matrix %*% Initial_teasel   # note: the '%*%' denotes 'matrix multiplication' in R. We'll go through this more later.     
Year1
  
```

Pretty simple!

To compute teasel abundance in year 2 of our simulation, we can simply repeat:

```{r}

# Project the population at time 2

thisYear <- Year1
nextYear <- teasel_matrix %*% thisYear
nextYear  # now we get the (age structured) population size at time 2!     

```

We could use this strategy to simulate abundance for ten years (or 20, or 30, or 10000)...

Notice the use of a **for loop** here!

```{r}

# Use a FOR loop to project the population dynamics for the next 10 years!

nYears <- 10
tenYears <- matrix(0,nrow=6,ncol=nYears+1)          # initialize storage array for recording age structured abundances for the next 10 years. 
rownames(tenYears) <- rownames(Initial_teasel)      # assign row and column names
colnames(tenYears) <- seq(0,10)
tenYears[,1] <- Initial_teasel                      # initialize the simulated abundances

# run the for loop!

for(t in 2:(nYears+1)){    # here we use 't' as our looping variable, but we could choose any name we want
  tenYears[,t] <-  teasel_matrix %*% tenYears[,t-1]     # perform matrix multiplication for each year of the simulation!
}

tenYears

```

Finally, we can plot out the abundance of each stage over 10 years!

```{r echo=FALSE}

# Plot the projected population trajectory over the next 10 years 

plot(1,1,pch="",ylim=c(0,60000000),xlim=c(0,11),xlab="Years",ylab="Abundance",xaxt="n")    # make empty plot
cols <- rainbow(6)        # set colors for each stage
for(s in 1:6){
  points(tenYears[s,],col=cols[s],type="l",lwd=2)       # plot out each stage
}
axis(1,at=seq(1,11),labels = seq(0,10))      # add x axis labels
legend("topleft",col=cols,lwd=rep(2,6),legend=rownames(tenYears))      # add legend

```

So projection is easy with matrices! What more reason do we need to convince ourselves of why matrix population models are worth knowing? Well, how about this...

### Reason 3: Matrix algebra 'tricks'!

Fortunately, we can compute two key population properties from the transition matrix using some mathematical tricks: 

1. We can compute **Lambda** from the transition matrix in one step
2. We can compute **Stable Stage Distribution (SSD) from the transition matrix in one step

#### Lambda
  
There is a clear similarity between the finite population growth equation:

$N_{t+1}=\lambda \cdot N_t$,

where $N$ is abundance (as always), $t$ is time, often in years but could be any time units, and $\lambda$ is the multiplicative growth rate over the time period $t \rightarrow t+1$

... and the matrix population growth equation:

$\mathbf{N}_{t+1} = \mathbf{A} \cdot \mathbf{N}_{t}$,

where $\mathbf{N}$ is a **vector** of abundances (abundance for all stages), and $\mathbf{A}$ is the **transition matrix**, which we have seen before.

Both equations describe discrete exponential growth or decline!

Note that $N$ in the first equation is a **scalar** -- that is, it is just a single number. 

In contrast:

$\mathbf{N}$ in the second equation represents an age-structured **vector (a bundle of numbers organized in a single line)**: a set of abundances structured by age or stage class.

Similarly, the finite population growth rate, $\lambda$ is a scalar,

In fact, the concept of **Lambda**, or the multiplier used to model discrete population growth, applies to matrix population models as well!

As you may have noticed from our age-structured InsightMaker model from class (or from Lab 3), age-structured models sometimes exhibit "messy" dynamics at first, when the population is jumping up and down a lot. However, after some time, the population growth becomes smooth- this is when the population has achieved *stable stage distribution (SSD)*. At SSD, the population grows in a discrete exponential growth pattern- this rate of exponential growth can be described by a single parameter -- **Lambda**!  

$\mathbf{A}$ is a **matrix (a bundle of numbers organized in rows and columns)** known as the transition matrix in Population Ecology.   

In one step, you can compute $\lambda$ from $\mathbf{A}$!!     

Let's do this in R!

What is the growth rate $\lambda$ for the teasel population. If you recall, it looked like it was growing, so it should be above 1...

```{r message=FALSE, warning=FALSE}

# Matrix "tricks" for population ecology ---------------------------

# Use the transition matrix to compute Lambda, or the finite rate of population growth!

library(popbio)      # load the 'popbio' package in R!
Lambda <- lambda(teasel_matrix) 
Lambda

#   as.numeric(round(eigen(teasel_matrix)$values[1],2))  # this is an alternative method- if you don't want to use the 'popbio' package

```

You don't have to understand the math here- but I do want you to understand how simple that was- just one line of code and we computed the annual rate of growth from the teasel transition matrix!

#### Stable Stage Distribution (SSD)

Here's another trick:

In one step, you can compute **stable stage distribution (SSD)** from $\mathbf{A}$!!     

Let's do this in R!

What is the stable age distribution for the teasel population. If you recall, the first seed stage looked like it dominated in the figure above.

```{r}

# Compute stable age distribution from the transition matrix!

library(popbio)    # ... and it's even easier if we use the 'popbio' package...
SAD <- stable.stage(teasel_matrix)  
SAD      # stable age distribution as a percentage of the total population


# #abs(as.numeric(round(eigen(teasel_matrix)$vectors[,1],3)))  # alternative- doesn't use 'popbio'
# SAD/sum(SAD)

```

This vector represents the _relative abundances in each age class at the stable age distribution_!

**Q:** Does a stage-structured population grow at the rate of $\lambda$ per time step if it is NOT at stable stage distribution (SSD)? [Top Hat]   

To answer this question, you may find it helps to load an stage-structured model in InsightMaker like [this one](https://insightmaker.com/insight/6vZsNuzGIbisYsFVCSLWZK/Stage-structured-population). 

## Mechanics of matrix population models

Let's take a look at a basic stage-structured population -- specifically [this one](https://insightmaker.com/insight/6vZsNuzGIbisYsFVCSLWZK/Stage-structured-population) - we used this model for running the 'supplementation' example in the 'age structured populations' lecture. In InsightMaker, it looks something like this:

![](IM9.jpg)

Let's convert the vital rates to a three-stage **projection matrix**. Projection matrices are **square matrices** where the number of rows and columns are equal to the number of life stages. In this case, that means three! Let's make a blank matrix for now:

```{r}

# Demo -------------------------
# In class demo: convert an insightmaker model to a matrix projection model

# First, we specify a blank transition matrix

TMat <- matrix(0,nrow=3,ncol=3)                    # create a blank matrix with 3 rows and 3 columns
stagenames <- c("Juveniles","Subadults","Adults")  # name the rows and columns
rownames(TMat) <- stagenames
colnames(TMat) <- stagenames
TMat                                               # now we have an all-zero transition matrix.

```

You can read the **elements** of a transition matrix as follows:

"The per-capita rate of transition from _(col name)_ this year to _(row name)_ next year is _(value of element)_" 

NOTE: the top row in the transition matrix represents **fecundities (f)**. These elements are best interpreted as follows:

"The per-capita production of newborns next year by _(col name)_ in the population this year is _(value of element)_".

These matrix elements account for both survival (surviving to the next year) and birth rate (birth rate one year from now). In life table terms:

$f_t = g(t) * b(t+1)$

Now we can start filling in this matrix. Let's begin with the top left **element** of the matrix (a **fecundity** term, since it's part of the top row). This represents the per-capita production of Juveniles (col) next year by Juveniles (row) this year. What is the value of this element? 

Let's update our transition matrix:

```{r}

# fill in the top left element of the matrix

TMat[1,1] <- 0
TMat

```

How about the second row, first column. This represents the per-capita transition from Juveniles (col) this year to Subadults (row) next year. That is, the transition rate from juvenile to subadult. The value from our model is 0.3. 

Let's update our transition matrix:

```{r}

# update the second row, first column (juvenile survival, or transition from juv to sub)

TMat[2,1] <- 0.3


# and the survival of adults (transition from adult to adult)

TMat[3,3] <- 1-0.15    # 85% survival


# transition from juv to juv 

TMat[2,2] <- 0.5-0.1    # 40% of juveniles survive and stay juvenile


# transition from juv to adult

TMat[3,2]  <- 0.1   # 10% of juveniles survive and transition to adult. 

```


And the hardest part is usually the top row: the fecundity row. In this case, this year's juveniles don't produce offspring next year, so they have fecundity of zero.

Subadalts can't reproduce- BUT, some of this year's subadults become adults next year, and these subadults will contribute offspring to the population next year!

Adults can reproduce, but this years adults must survive if they are to produce offspring next year!

```{r}

TMat[1,2] <- 0.1*4      # subadult fecundity term

TMat[1,3] <- 0.85*4     # adult fecundity term

```


If we keep going, we get the following matrix. See if you can understand what this matrix is saying about the transitions from and two the three life stages. 

```{r}

# alternatively, you can fill in the matrix like this:

TMat[,1] <- c(0,0.3,0)              # fill in the entire first column of the transition matrix
TMat[,2] <- c(0.1*4,0.4,0.1)        # fill in the entire second column of the transition matrix
TMat[,3] <- c(0.85*4,0,0.85)        # fill in the entire third column of the transition matrix
TMat

```

Now we can run a 40-year projection and compare it with the InsightMaker model. It should look the same!!

First we must specify the initial abundances in each stage:

```{r}

# specify initial abundance vector

InitAbund <- c(40,0,0)
names(InitAbund) <- colnames(TMat)
InitAbund

```

So we are starting with only Juveniles...

```{r}

# Run the model for 50 years (using for loop)

nYears <- 50
allYears <- matrix(0,nrow=nrow(TMat),ncol=nYears+1)
rownames(allYears) <- rownames(TMat)
colnames(allYears) <- seq(0,nYears)
allYears[,1] <- InitAbund 

for(t in 2:(nYears+1)){
  allYears[,t] <-  TMat %*% allYears[,t-1]    # matrix multiplication!
}

allYears

```


Now let's plot it out!

```{r}

# and plot out the results!

plot(1,1,pch="",ylim=c(0,50),xlim=c(0,nYears+1),xlab="Years",ylab="Abundance",xaxt="n")
cols <- rainbow(3)
for(s in 1:3){
  points(allYears[s,],col=cols[s],type="l",lwd=2)
}
axis(1,at=seq(1,nYears+1),labels = seq(0,nYears))
legend("topleft",col=cols,lwd=rep(2,3),legend=rownames(allYears),bty="n")

```

Does this look the same as the InsightMaker results? Check it to make sure!

## Limitations of matrix population models

Matrix population models are great, but they have some limitations too. 

### What about density-dependence?

In some ways, while introducing a new level of realism in our models -- age-structure -- we have been ignoring another type of realism that we introduced in earlier lectures- **density-dependence** (both positive and negative)!

Which vital rates are density-dependent? All? Some? It depends? Are the data available?

How do you incorporate density-dependence into a matrix population model?  

How do you incorporate predator-prey dynamics into a matrix population model?      

ANSWER: use computer programming (e.g., R or InsightMaker!) 

### Overview of matrix multiplication

(we will do this on the whiteboard!)

### In-class exercise: loggerhead conservation!

First, please review the introduction to loggerhead sea turtles [here](PVA3_421.html). 

Next, download the Excel document for this example [here](Loggerhead2022.xlsx). We will work through the Excel example in class.

NOTE: a worked version of the spreadsheet can be found here[](Loggerhead2022_worked.xlsx)

Using your Excel spreadsheet, investigate four management scenarios for the loggerhead turtle population:

1. Improve fecundity (both subadults and adults) via *nest-site protection*!
    - Increase fecundity terms by 50% (improve to 1.5 times the current value)      
2. Improve hatchling survival via *nest monitoring*
    - Improve _to_ 100%    
3. Improve large juvenile survival using *Turtle Excluder Devices (TEDs)*     
    - Add 0.25 to the existing large juvenile survival (prob of transition from LJ to LJ)      
4. Improve adult survival by *restricting longline fisheries*.     
    - Increase by 10% (add 0.1 to adult survival)          
    
    
![turtle excluder device](ted1.jpg)    

**PointSolutions**: Which of the four management recommendations would have the greatest positive effect on this population?

Click this link to download a CSV file of the loggerhead transition matrix (for reading into R): [CSV link](LoggerheadMatrix.csv)

### translate life history description into matrix population model

If we have time, we may review the final question from Lab 4:

Translate the following paragraph into a matrix population model. Remember a matrix population model has two components- an **initial abundance vector** and a **transition matrix**.  


![](redtail1.jpg)

> We assumed that the red-tailed hawk life history could be described in terms of three major life stages: hatchling (first year of life), juvenile (largely individuals in their second year of life), and adult (generally the third year of life and beyond). We assumed that adult females experienced an average of 15% mortality each year. Juvenile female mortality was set at 30% per year. Approximately 10% of juvenile females remain in the juvenile phase each year, and all other survivors transition to the adult stage. Finally, hatchlings had a 21% chance of surviving and transitioning to become juveniles. Adults are the primary reproductive stage, and produce an average of 6 new hatchlings each year, half of which are female. Juveniles that fail to transition to the Adult stage tend to produce only 1.8 new hatchlings each year on average, half of which are female. We ran a female-only matrix population model, and we initialized the population with 800 hatchlings, 150 juveniles, and 50 adults.   


```{r eval=FALSE, echo=FALSE}

mymat = matrix(c(0,    0.1*0.5*1.8+0.7*6*0.5,        6*0.5*0.85, 
                 0.21,  0.1,                 0,
                 0,    0.7,                 0.85),   nrow=3,byrow = T)
popbio::lambda(mymat)
mymat

```


For more on matrix population models, the bible of this subject is [this book by Hal Caswell](https://www.amazon.com/gp/huc/view.html?ie=UTF8&newItems=C1DH1414B1C6AK%2C1).

And finally, check this out- this is a database of thousands of stage matrices for plants and animals around the world:

[COMADRE and COMPADRE databases](https://compadre-db.org/Data)


[--go to next lecture--](LECTURE8.html)
























