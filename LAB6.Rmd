---
title: "Lab 6: Metapopulation modeling"
author: "NRES 470/670"
date: "Spring 2023"
output: 
  html_document: 
    theme: spacelab
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
```

## Some definitions

In this lab we will step back from single-population models to consider multiple populations! A collection of populations that are connected via dispersal is called a **metapopulation**. The simplest types of spatially structured population model are the **classical metapopulation models** (covered in Gotelli Ch 4). 

In this model, we have a **landscape** with a certain number of habitable **patches**. Patches are either **occupied** (coded as 1) or not (coded as 0). 

In the classical metapopulation framework, we are not keeping track of abundance ($N$) any more- we are just keeping track of whether each patch is occupied or not, and how many total occupied patches we have in our metapopulation. A patch is composed of individuals, whereas a metapopulation is composed of patches!

**colonization** is when an unoccupied patch becomes occupied! (via **immigration**).  

**extinction** (or extirpation) is when an extant (occupied) patch becomes unoccupied.

**regional (or global) extinction** represents extinction of all patches in the metapopulation. (note that this can't happen in a classical metapopulation- but it certainly CAN happen in real life)

More formally, here are some terms we will consider:

$f_t$ is the fraction of patches that are occupied at time $t$. This is the primary [Stock] in our classical metapopulation models.  

$I$ is the total fraction of the metapopulation that is colonized by immigrants in a given time period (colonization rate, or "immigration" rate) 

$E$ is the total fraction of the metapopulation that goes extinct per time period (extirpation rate)

Therefore, the absolute change in metapopulation occupancy can be expressed as:

$\Delta f = I - E  \qquad \text{(Eq. 1)}$

$p_i$ is the probability of colonization *for any unoccupied patch*.

$p_e$ is the probability of extinction *for any occupied patch*.

If most patches in the landscape are unoccupied, then the majority of the metapopulation is available to be colonized. 

If most patches in the landscape are already occupied, then most of the metapopulation is unavailable for colonization. 

We can express this mathematically:

$I = p_i\cdot (1-f)  \qquad \text{(Eq. 2)}$  

If most patches in the landscape are occupied, then the majority of the metapopulation can potentially go extinct. 

If most patches in the landscape are unoccupied, then most of the metapopulation is unavailable for extinction. We can express this mathematically:

$E = p_e\cdot f  \qquad \text{(Eq. 3)}$

Finally, all classical metapopulation models assume the following:   

- Homogeneous patches (all patches equal and interchangeable)
- Spatial context does not affect extinction and colonization parameters
- No time lags
- Very large number of patches

## Classical metapopulation model variants:

### Variant #1: island-mainland model

Colonization occurs via immigration from a constant external source (**propagule rain**). This is our simplest classical metapopulation model.

This model (and only this model) assumes that per-patch extinction and colonization rates ($p_i$ and $p_e$) are not dependent on the fraction of patches occupied ($f$). That is, $p_i$ and $p_e$ are constant (unchanging over time regardless of the status of the metapopulation).

Combining equations 1, 2, and 3, we get the island-mainland metapopulation model:

$\Delta f = p_i(1-f)-p_ef  \qquad \text{(Eq. 4)}$

### Variant #2: internal colonization

In this scenario, colonization can only happen via immigration from within the metapopulation itself. So when few patches are colonized, colonization of "empty" patches is low because of a lack of potential colonizers. 

$p_i = i \cdot f   \qquad \text{(Eq. 5)}$

In this model, the colonization rate approaches $i$ as nearly all patches become occupied, and approaches zero as the metapopulation approaches global extinction

All other elements remain unchanged from the island-mainland model.  

### Variant #3: rescue effect. 

Under the rescue effect model, the extinction rate can be reduced by immigration from other patches in the metapopulation!

$p_e = e(1-f)   \qquad \text{(Eq. 6)}$

In this model, the extinction rate approaches 0 as the metapopulation approaches full occupancy [note, this may not be realistic, as it implies a perfectly successful rescue effect!]. 

On the other hand, the extinction rate approaches $e$ as the metapopulation approaches global extirpation (when there are little to no immigrants from other occupied patches that could 'rescue' an occupied patch from extinction). 

All other elements remain unchanged from the island-mainland model.

### Variant #4: both internal colonization AND rescue effect!

This one is pretty self-explanatory. But it has some interesting emergent properties!

## What is a metapopulation?

Finally, the term *metapopulation* is often used to refer to models where we don't care about abundance, we only care about occupancy- as in the 'classical' models described above. 

However, a metapopulation more generally is simply a *collection of interconnected habitat patches*. 
We can keep track of patch abundance in a metapopulation model if we want. In fact, each patch can contain a stage-structured, density dependent population if we really want. The level of complexity/detail in our models is totally under our control as modelers! 

Just as we can use metapopulation models to study the probability of **global extinction**, we can also study **global abundance** and global abundance trends across the entire metapopulation. 

## Exercise 1: 'classical' metapopulation models in InsightMaker

NOTE: _you will need the Gotelli book (Chapter 4) to answer several questions_

First, build an InsightMaker model to represent the basic island-mainland metapopulation model described above. 

The total fraction of occupied patches $f$ should be represented as a [Stock]. Make sure this stock can not go negative. 

There should be two [Flows]: one for *colonization* (I) and one for *extinction* (E). Initialize $f$ at 0.25 (set the initial value of the stock at year 0 to 25% of patches occupied). 

The extinction and colonization probabilities ($p_e$ and $p_i$) should be represented as [Variables]. In the island-mainland model, these are constants. Set $p_e$ to 0.15 and $p_i$ to 0.45. 
Use the description of the island-mainland model above (and in Gotelli Ch. 4) to complete your model (drawing the appropriate links, and setting appropriate equations for I and E (the Flows). 

Simulate the metapopulation for 100 years and make sure that $f$ reaches an equilibrium value between 0 and 1.

1a. Clone your Insight and provide a link to your working InsightMaker metapopulation model. 

1b. Run the model you submitted above (1a) for 100 years. Based on your simulation, what is the equilibrium value for $f$ in this model? 

1c. Using your Insightmaker model above (submitted in 1a), test to see if the equilibrium state that the model reaches (constant $f$ over time; question 1b) is **stable** or **unstable**? Explain how you got your answer. 

1d. Use equation 4.4 from the Gotelli book to compute the equilibrium value of $f$. Upload an image showing how how you computed your answer using Gotelli's equation 4.4. [NOTE: this should match your answer to 1b] 

Next, working with a clone of the model you submitted in part 1a, please make an InsightMaker model that represents the *internal colonization* model (see description above).

In this model, you will define $p_i$ as a function of a new parameter called $i$. Set the parameter $i$ to 0.3 and run a 100 year simulation. Keep $p_e$ set constant at 0.15. Initialize $f$ at 0.25.

2a. Clone your Insight and provide a link to your working InsightMaker metapopulation model representing internal colonization.

2b. Run the model you submitted above (2a) for 100 years. Based on your simulation, what is the equilibrium value for $f$ in this model?

2c. Use equation 4.6 from the Gotelli book to compute the equilibrium value of $f$ in this model. Upload an image showing how how you computed your answer using Gotelli's equation 4.6. [NOTE: this should match your answer to 2b]. 

Next, working with a clone of the model you submitted in part 1a, please change your InsightMaker model to reflect the *rescue effect* (see above). In this model, $p_e$ is a function of $f$. Return $p_i$ to its original value of 0.45. Initialize $f$ at 0.25.

Set the parameter $e$ in the "rescue effect" model to 0.65. 

3a. Clone your Insight and provide a link to your working InsightMaker metapopulation model representing the rescue effect.

3b. Run the model you submitted above (3a) for 100 years. Based on your simulation, what is the equilibrium value for $f$ in this model?

3c. Use equation 4.8 from the Gotelli book to compute the equilibrium value of $f$ in this model. Upload an image showing how how you computed your answer using Gotelli's equation 4.8. [NOTE: this should match your answer to 2b]. 

Finally, working with a clone of one of the models you built above (e.g., 3a), please change your InsightMaker model to reflect the *rescue effect* AND *internal colonization* (both processes operating in the same model). Set the parameter $i$ to 0.3. Set the parameter $e$ to 0.65. Initialize $f$ at 0.25. 

4a. Run the model you submitted above (4a) for 100 years. Based on your simulation, what is the equilibrium value for $f$ in this model?

Just for fun, try some alternative values for the e and i parameters in this model and simulate for 100 years. What happens to the equilibrium value for f under different scenarios (optional-no assignment). 


## Exercise 5: a spatial metapopulation model!

Agent-based models (individual-based models) are well-suited for considering spatial context. In addition to being a flexible system for stock-flow modeling, Insightmaker also has the capability of running agent-based simulation models. If you want to learn more about agent-based models for modeling populations, check out [this overview](LECTURE10.html) 

I have already prepared an agent-based metapopulation model for you. You can access and clone this model [here](https://insightmaker.com/insight/74948/Agent-based-metapopulation-model).

Each population/patch in the metapopulation is represented by an "individual", or "agent". These individuals cannot move (they are patches of land, after all), but they can influence each other via immigration and emigration!

The landscape is 200 km by 200 km. Each time a simulation is initiated, patches are placed randomly in the landscape. The **metapopulation size** (total number of patches) is initialized at 10 (but you can change this quantity using a slider bar). 

Each patch potentially contains a population of animals. If it has >= 2 individuals living in it, it is considered "occupied".

Each patch has its own carrying capacity (K)- some patches have very low carrying capacity, and some have very high carrying capacity. The distribution of K among patches is approximately *lognormal*. This means that there will usually be a few very large patches in the landscape but most patches are pretty small. The minimum K for any patch is 2. 

Abundance dynamics are density-dependent, and population growth is computed as a function of **r_max**, **local carrying capacity**, and previous-year local abundance using the **Ricker** growth model:

$N_{t+1} = N_t e^{r_{max}(1-\frac{N_t}{K})}$

This is one of the most commonly used models for discrete logistic population growth (very analogous to the logistic growth model we have already seen!).

Population growth in each patch is also driven by migration to and from nearby patches. A fixed proportion of the population in each patch disperses each year (**dispersal rate**, set to 25% initially), and the **maximum dispersal distance** is set initially at 50 kilometers. If no neighboring patch exists within that distance, all dispersers die. Therefore, spatial context matters! 

There is, of course, demographic stochasticity in this model! 

Graphical summaries are available, which illustrate the spatial configuration of the patches, the total metapopulation occupancy, the total metapopulation abundance, and the total numbers of immigrants/emigrants.

Take some time to open the model (clone it!) and get familiar with the parameters and model behavior. If you don't understand something, ask your instructor or TA! Make sure you have the following starting parameters:

Metapopulation size: 10 patches     
r_max: 0.11      
maxdist (maximum dispersal distance): 50 kilometers       
dispersal rate: 0.25      
Mean K per population: 10          

NOTE: there is one parameter (max dispersal distance, or 'maxdist') you will need to pay attention to, but it is not represented by a value slider (I couldn't get it to work that way, unfortunately). To alter the maximum dispersal distance, you need to open the equation editor for the [Immigrants] variable, and change the value in the top line, which should look something like this:

```
maxdist <- 50
```

5a. Use InsightMaker's *sensitivity testing tool* to run the model 100 times (or 50 times, if your browser crashes!), monitoring the total metapopulation occupancy. What is the approximate risk of regional (global) extinction of this metapopulation over 100 years? Briefly explain how you got your answer. 

5b. Use InsightMaker's *sensitivity testing tool* to run the model 100 times (or 50 times, if your browser crashes!), monitoring the total metapopulation abundance. Using the results, briefly describe (i) the abundance trend over time (that is, the trend in overall metapopulation abundance) and (ii) your uncertainty about the total metapopulation abundance at year 100.  

Finally, imagine that this metapopulation represents the last remaining patches of habitat for an endangered butterfly. You have identified three possible management strategies: Starting from the initial conditions specified at the beginning of this exercise, you could:    
      
i. Improve the intervening, or "matrix", habitat, effectively doubling the maximum dispersal distance (individuals are able to disperse more effectively over longer distances). [see note above about how to change the maximum dispersal distance]         
ii. Improve existing habitats, doubling the mean per-patch carrying capacity (labeled "Mean K per population").       
iii. Restore habitat, effectively doubling the number of patches (labeled "metapopulation").           
Which management strategy would be most effective for ensuring that the metapopulation does not go extinct? Please justify your answer.   


##Checklist for Lab 6 completion

* Please submit all answers on WebCampus!

***Due Apr. 21 at 11:59pm***

  +  **Exercise 1**
      -  *InsightMaker link (1a.)*   
      -  *Short answer (1b.)*   
      -  *Short answer (1c.)*
      -  *Image upload (1d.)*
      
  +  **Exercise 2**
      -  *InsightMaker link (2a.)*   
      -  *Short answer (2b.)*   
      -  *Image upload (2c.)*
      
  +  **Exercise 3**
      -  *InsightMaker link (3a.)*   
      -  *Short answer (2b.)*   
      -  *Image upload (2c.)*
      
  +  **Exercise 4**
      -  *Short answer (4a.)*   

  +  **Exercise 5**
      -  *Short answer (5a.)*
      -  *Short answer (5b.)*
      -  *Short answer (5c.)*

        

```{r eval=FALSE, echo=FALSE}

# 2b. Change the dispersal rate to zero. Run a few simulations to examine the model behavior. Re-run the sensitivity testing tool to examine expected patterns in occupancy and abundance over time. How did the trend in regional abundance change relative to the scenario with 25% dispersal? What about the probability of regional extinction? Include figures. Do these results match with your expectation of what would happen? Why or why not? 
# 
# 2c. Change the dispersal rate back to 25% and increase the number of patches to 25. Run a few simulations to examine the model behavior. Re-run the sensitivity testing tool (note that InsightMaker will run slower with more patches!) to examine expected patterns in occupancy and abundance over time. How did the trend in abundance change relative to the scenario with 10 patches? What about the probability of regional extinction? Include figures to justify your answer. Do these results match with your expectation of what would happen? Why or why not?

```




































 

































